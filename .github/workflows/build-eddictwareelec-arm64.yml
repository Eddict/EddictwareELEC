name: Build EddictwareELEC (aarch64)

description: |
  CI workflow to build EddictwareELEC for RPi4 (aarch64) using the official build command.

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use'
        required: false
        default: ubuntu-24.04
        type: choice
        options:
          - ubuntu-24.04
          - ubuntu-24.04-arm
          - self-hosted
          - self-hosted-sysbox
      largest_packages_only:
        description: 'Remove only the largest packages (from installed-packages-largest.txt)'
        required: false
        default: true
        type: boolean
  # push:
  #   branches: [ master ]
  # pull_request:
  #   branches: [ master ]

run-name: ${{ format('{0} ({1})', github.workflow, inputs.runner || 'ubuntu-24.04') }}

jobs:
  build:
    runs-on: ${{ (github.event_name == 'workflow_dispatch' && (inputs.runner == 'self-hosted-sysbox' && fromJson('["self-hosted", "sysbox"]') || inputs.runner)) || 'ubuntu-24.04' }}
    env:
      DISTRO: EddictwareELEC
      PROJECT: RPi
      DEVICE: RPi4
      ARCH: aarch64
      LARGEST_SUFFIX: ${{ inputs.largest_packages_only && '(largest only)' || '' }}
      DEBIAN_FRONTEND: noninteractive
    steps:
      - id: list_installed_packages
        name: List installed packages before build
        if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        run: |
          echo "Running apt-get update:"
          sudo apt-get update -qq
          echo "Listing installed packages (dpkg-query):"
          dpkg-query -W -f='${Package}\t${Version}\t${Installed-Size}\n' | sort > installed-packages.txt
          # List top 30 by size (in KB)
          sort -k3 -n -r installed-packages.txt | head -n 30 > installed-packages-largest.txt
          echo "Top 30 largest packages (name, version, size KB):"
          cat installed-packages-largest.txt
          echo "Full list saved to installed-packages.txt (size in KB in 3rd column)"
          df -h
          du -h --max-depth=2 | sort -hr | head -n 10

      - id: upload_installed_packages
        name: Upload installed packages lists
        if: steps.list_installed_packages.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: installed-packages
          path: |
            installed-packages.txt
            installed-packages-largest.txt
          if-no-files-found: warn

      - id: remove_browsers
        name: Remove browsers and GUI apps ${{ env.LARGEST_SUFFIX }}
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          if [[ ${{ inputs.largest_packages_only }} ]]; then
            sudo apt-get purge -y -qq firefox google-chrome-stable microsoft-edge-stable
          else
            sudo apt-get purge -y -qq firefox google-chrome-stable microsoft-edge-stable
          fi
          sudo apt-get autoremove -y

      - id: remove_cloud_tools
        name: Remove cloud/VM/container tools ${{ env.LARGEST_SUFFIX }}
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          if [[ ${{ inputs.largest_packages_only }} ]]; then
            sudo apt-get purge -y -qq azure-cli google-cloud-cli kubectl containerd.io docker-ce snapd google-cloud-cli-anthoscli
          else
            sudo apt-get purge -y -qq azure-cli google-cloud-cli kubectl podman docker-ce docker-ce-cli containerd.io open-vm-tools lxd-installer lxd-agent-loader cloud-init cloud-guest-utils overlayroot walinuxagent snapd google-cloud-cli-anthoscli
          fi
          sudo apt-get autoremove -y

      - id: remove_db_servers
        name: Remove database servers/clients ${{ env.LARGEST_SUFFIX }}
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          if [[ ${{ inputs.largest_packages_only }} ]]; then
            sudo apt-get purge -y -qq mysql-server-core-8.0
          else
            sudo apt-get purge -y -qq mysql-server* mysql-client* postgresql-* sqlite3 mediainfo sphinxsearch freetds-common
          fi
          sudo apt-get autoremove -y

      - id: remove_web_servers
        name: Remove web servers and scripting ${{ env.LARGEST_SUFFIX }}
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          if [[ ${{ inputs.largest_packages_only }} ]]; then
            sudo apt-get purge -y -qq powershell
          else
            sudo apt-get purge -y -qq apache2* nginx* php* php8.3-* ruby* ruby3.2-* powershell
          fi
          sudo apt-get autoremove -y

      - id: remove_extra_compilers
        name: Remove extra compilers/interpreters ${{ env.LARGEST_SUFFIX }}
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          if [[ ${{ inputs.largest_packages_only }} ]]; then
            sudo apt-get purge -y -qq temurin-8-jdk temurin-11-jdk temurin-17-jdk temurin-21-jdk temurin-25-jdk llvm-16-dev llvm-17-dev llvm-18-dev libllvm16t64 libllvm17t64 libllvm18 libllvm19 libllvm20 llvm-16 llvm-17 llvm-18
          else
            sudo apt-get purge -y -qq clang-* clang-tidy-* clang-tools-* llvm-* gfortran-* python3.12* temurin-*-jdk
          fi
          sudo apt-get autoremove -y

      - id: remove_misc_tools
        name: Remove miscellaneous tools ${{ env.LARGEST_SUFFIX }}
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          if [[ ${{ inputs.largest_packages_only }} ]]; then
            sudo apt-get purge -y -qq python3-botocore linux-azure-6.11-headers-6.11.0-1018
          else
            sudo apt-get purge -y -qq byobu htop tmux screen mercurial git-ftp git-lfs shellcheck snapd session-manager-plugin parallel upx-ucl tree pastebinit
          fi
          sudo apt-get autoremove -y -qq

      - id: apt_clean
        name: Clean up apt cache
        if: steps.list_installed_packages.outcome == 'success'
        run: |
          sudo apt-get clean -qq
          echo "Disk usage after removing packages:"
          df -h
          du -h --max-depth=2 | sort -hr | head -n 10

      - id: upload_installed_packages_after_cleanup
        name: Upload installed packages list after cleanup
        uses: actions/upload-artifact@v4
        with:
          name: installed-packages-after-cleanup
          path: installed-packages-after-cleanup.txt
          if-no-files-found: warn

      - id: checkout
        name: Checkout EddictwareELEC
        uses: actions/checkout@v4
        with:
          repository: Eddict/EddictwareELEC
          ref: upstream
          path: ${{ github.workspace }}
          clean: false

      - id: install_deps_org
        name: Install build dependencies original (for non-self-hosted runners)
        if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y -qq \
            git make gcc g++ bc bzip2 unzip wget python3 python3-pip xz-utils \
            libssl-dev libncurses5-dev libncursesw5-dev zlib1g-dev gawk flex gettext \
            xsltproc rsync file \
            xfonts-utils libjson-perl rdfind libparse-yapp-perl gperf \
            libxml-parser-perl patchutils lzop \
            default-jre zip zstd sudo dumb-init jq \
            device-tree-compiler ccache kmod keyutils openssl elfutils u-boot-tools pigz mtools squashfs-tools

      - id: install_deps
        name: Install build dependencies (for non-self-hosted runners)
        if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y -qq \
            xsltproc xfonts-utils rdfind libparse-yapp-perl gperf \
            libxml-parser-perl patchutils lzop

      - id: install_arm_deps
        name: Install build dependencies (for arm64 runners)
        if: ${{ contains(inputs.runner || '', '-arm') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y -qq \
            libjson-perl

      - id: chown_workspace
        name: Chown workspace to non-root user
        run: |
          if [ "$(id -u)" = 0 ]; then
            BUILDUSER="runner"
            echo "Running as root, switching to $BUILDUSER for build."
            if id "$BUILDUSER" >/dev/null 2>&1; then
              echo "Ensuring $BUILDUSER owns the workspace (will chown only if needed)..."
              # Only chown if needed (avoid unnecessary chown)
              if [ "$(stat -c %U "$PWD")" != "$BUILDUSER" ]; then
                chown -R "$BUILDUSER" "$PWD"
              else
                echo "Workspace already owned by $BUILDUSER, skipping chown."
              fi
            else
              echo "User $BUILDUSER does not exist. Please create a non-root user for builds." >&2
              exit 1
            fi
          else
            echo "Not running as root ($(whoami)), no need to change ownership."
          fi

      - id: calc_build_params
        name: Calculate recommended make -j and -l parameters
        run: |
          set -euo pipefail
          NB_CORES=$(grep -c '^processor' /proc/cpuinfo || nproc)
          PER_JOB_MB=${PER_JOB_MB:-1200}
          RESERVE_MB=${RESERVE_MB:-4096}
          mem_bytes=0
          if [ -f /sys/fs/cgroup/memory.max ]; then
            memmax=$(cat /sys/fs/cgroup/memory.max)
            if [ "$memmax" != "max" ]; then
              mem_bytes=$memmax
            fi
          fi
          if [ "$mem_bytes" -eq 0 ] 2>/dev/null; then
            if [ -f /sys/fs/cgroup/memory/memory.limit_in_bytes ]; then
              memlim=$(cat /sys/fs/cgroup/memory/memory.limit_in_bytes)
              if [ "$memlim" -lt 9223372036854771712 ] 2>/dev/null; then
                mem_bytes=$memlim
              fi
            fi
          fi
          if [ "$mem_bytes" -eq 0 ] 2>/dev/null; then
            mem_kb=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
            mem_bytes=$((mem_kb*1024))
          fi
          TOTAL_MB=$((mem_bytes/1024/1024))
          USABLE_MB=$((TOTAL_MB-RESERVE_MB))
          if [ "$USABLE_MB" -lt 256 ]; then USABLE_MB=256; fi
          MAX_J_BY_RAM=$((USABLE_MB/PER_JOB_MB))
          if [ "$MAX_J_BY_RAM" -lt 1 ]; then MAX_J_BY_RAM=1; fi
          CANDIDATE_J=$((NB_CORES+2))
          if [ "$CANDIDATE_J" -gt "$MAX_J_BY_RAM" ]; then RECOMMENDED_J=$MAX_J_BY_RAM; else RECOMMENDED_J=$CANDIDATE_J; fi
          if [ "$RECOMMENDED_J" -gt $((NB_CORES*2)) ]; then RECOMMENDED_J=$((NB_CORES*2)); fi
          RECOMMENDED_L=${NB_CORES}
          echo "Using make -j${RECOMMENDED_J} -l${RECOMMENDED_L}"
          echo "RECOMMENDED_J=${RECOMMENDED_J}" >> $GITHUB_ENV
          echo "RECOMMENDED_L=${RECOMMENDED_L}" >> $GITHUB_ENV


      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: |
            ./build.${{ env.DISTRO }}-${{ env.DEVICE }}.${{ env.ARCH }}-13.0-devel/.ccache
            ./build.${{ env.DISTRO }}-${{ env.DEVICE }}.${{ env.ARCH }}-13.0-devel/.ccache-local
          key: ccache-${{ runner.os }}-${{ hashFiles('packages/*/package.mk') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Cache source archives
        uses: actions/cache@v4
        with:
          path: sources
          key: sources-${{ runner.os }}-${{ hashFiles('packages/*/package.mk') }}
          restore-keys: |
            sources-${{ runner.os }}-

      - id: check_disk_space
        name: Check free disk space before build
        # if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        run: |
          echo "Disk usage before build:"
          df -h
          echo "Top 10 largest directories in workspace:"
          du -h --max-depth=2 | sort -hr | head -n 10

      - id: cleanup_tmp
        name: Cleanup /tmp and unused caches
        # if: ${{ !contains(inputs.runner || '', 'self-hosted') }}
        run: |
          echo "Cleaning /tmp, /var/tmp, and runner cache..."
          sudo rm -rf /tmp/* /var/tmp/* || true
          sudo find /home/runner/actions-runner/cached/ -type f -name '*.log' -delete || true
          sudo find /home/runner/actions-runner/cached/ -type f -size +100M -delete || true
          echo "Disk usage after cleanup:"
          df -h
          du -h --max-depth=2 | sort -hr | head -n 10

      - id: build_image
        name: Build EddictwareELEC image
        env:
          MAKEFLAGS: -s
        run: |
          set -o pipefail
          BUILDUSER="runner"
          sudo -u "$BUILDUSER" bash -c '
            cd "$PWD"
            DISTRO=${{ env.DISTRO }} PROJECT=${{ env.PROJECT }} DEVICE=${{ env.DEVICE }} ARCH=${{ env.ARCH }} \
            make -j${RECOMMENDED_J:-$(nproc)} -l${RECOMMENDED_L:-$(nproc)} image 2>&1 | tee build.log
            exit ${PIPESTATUS[0]}
          '

      - id: list_images
        name: List built images
        run: |
          ls -lh ./target/*.img.gz || true

      - id: upload_image
        name: Upload built image artifact
        uses: actions/upload-artifact@v4
        with:
          name: EddictwareELEC-RPi4-aarch64-image
          path: ./target/*.img.gz
          if-no-files-found: warn

      - id: upload_log
        name: Upload full build log
        uses: actions/upload-artifact@v4
        with:
          name: build.log
          path: build.log
          if-no-files-found: warn