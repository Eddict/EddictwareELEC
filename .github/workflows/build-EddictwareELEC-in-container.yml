name: Build image in container

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to run against'
        required: true
        type: choice
        options:
          - self-hosted
          - github
        default: github
      os:
        description: 'OS of build container'
        required: true
        type: choice
        options:
          - bookworm
          - jammy
          - noble
          - noble-custom
          - plucky
          - questing
          - sid
        default: noble
      arch:
        description: 'Arch of build target'
        required: true
        type: choice
        options:
          - amd64
          - aarch64
          - arm
          - x86_64
        default: aarch64

run-name: ${{ format('{0} ({1}/{2}/{3})', github.workflow, inputs.runner, inputs.os, inputs.arch) }}

env:
  DistroCodeName: ${{ github.event.inputs.os }}
  EE_Distro: EddictwareELEC
  EE_Project: RPi
  EE_Device: RPi4
  EE_Arch: ${{ github.event.inputs.arch }}
  EE_image_pathfilename: ""
  EE_image_filename: ""
  # EE_Registry: ${{ secrets.REGISTRY_PRIVATE_FQDN }} # ${{ secrets.REGISTRY_FQDN }}
  EE_Registry: ghcr.io

defaults:
  run:
    shell: bash

jobs:
  init:
    runs-on: ${{ inputs.runner == 'github' && 'ubuntu-latest' || inputs.runner }}
    permissions:
      contents: read
      packages: read
      attestations: read
      id-token: write
    if: github.event.head_commit.author.username != 'Eddict' || github.event_name == 'workflow_dispatch'
      # && github.event_name != 'pull_request' && github.event_name != 'workflow_dispatch'
    env:
      BUILDKIT_PROGRESS: 'auto' #'plain' 'quiet'
    # Expose step outputs as job outputs
    outputs:
      output_ee_distro_tag: ${{ steps.compose-image-tag.outputs.EE_Distro_tag }}
      docker_guid: ${{ steps.get-docker-guid.outputs.docker_guid }}
    steps:
    - name: Get Date
      id: get-date
      run: |
        # echo "[date]: $(/bin/date -u "+%Y%m%d")"
        echo "date=$(/bin/date -u "+%Y%m%d")" >> $GITHUB_OUTPUT

    - name: Get docker guid
      id: get-docker-guid
      run: |
        echo "docker_guid=$(id -u docker 2>/dev/null || echo 1000)" >> $GITHUB_OUTPUT

    - name: Compose image tag
      id: compose-image-tag
      run: |
        # ghcr.io/eddict/eddictwareelec-questing:latest
        # echo "DistroCodeName=${DistroCodeName}"
        # echo "DistroCodeName@L=${DistroCodeName@L}"
        # EE_Distro_tag="${{ env.EE_Registry }}/eddict/${DistroCodeName@L}"
        # echo "EE_Distro_tag=${EE_Distro_tag}" >> $GITHUB_OUTPUT
        dTag="${{ env.EE_Registry }}/eddict/${{ env.EE_Distro }}-${DistroCodeName@L}:latest"
        # Use ,, to convert all characters to lowercase
        echo "EE_Distro_tag=${dTag,,}"
        echo "EE_Distro_tag=${dTag,,}" >> $GITHUB_OUTPUT

        # value=$(printf '%s' "$EE_Distro_tag" | sed 's/%25/%/g; s/%0D/\r/g; s/%0A/\n/g')
        # echo "value=$value"
        # echo "Trick to echo EE_Distro_tag:"
        # echo "$value" | sed 's/./& /g' | awk '{print substr($0,1,100);exit}'

        # value=$(printf '%s' "${{ secrets.REGISTRY_FQDN }}" | sed 's/%25/%/g; s/%0D/\r/g; s/%0A/\n/g')
        # echo "value=$value"
        # echo "Trick to echo REGISTRY_FQDN:"
        # echo "$value" | sed 's/./& /g' | awk '{print substr($0,1,100);exit}'

        # value=$(printf '%s' "${{ secrets.REGISTRY_PRIVATE_FQDN }}" | sed 's/%25/%/g; s/%0D/\r/g; s/%0A/\n/g')
        # echo "value=$value"
        # echo "Trick to echo REGISTRY_PRIVATE_FQDN:"
        # echo "$value" | sed 's/./& /g' | awk '{print substr($0,1,100);exit}'

        # value=$(printf '%s' "${{ secrets.REGISTRY_USER }}" | sed 's/%25/%/g; s/%0D/\r/g; s/%0A/\n/g')
        # echo "value=$value"
        # echo "Trick to echo REGISTRY_USER:"
        # echo "$value" | sed 's/./& /g' | awk '{print substr($0,1,100);exit}'

  build:
    runs-on: ${{ inputs.runner == 'github' && 'ubuntu-latest' || inputs.runner }}
    needs: init
    # container:
    #   image: ${{ needs.init.outputs.output_ee_distro_tag }}
    #   credentials:
    #     username: ${{ secrets.REGISTRY_USER }}
    #     password: ${{ secrets.REGISTRY_PWD }}
    steps:
    # - name: Echo out to the logs
    #   run: |
    #     value=$(printf '%s' "${{ needs.init.outputs.output_ee_distro_tag }}" | sed 's/%25/%/g; s/%0D/\r/g; s/%0A/\n/g')
    #     echo "Trick to echo output_ee_distro_tag:"
    #     echo "$value" | sed 's/./& /g' | awk '{print substr($0,1,60);exit}'
    #     # echo "$value" | sed 's/./& /g'
    #     value=$(printf '%s' "${{ env.EE_Registry }}" | sed 's/%25/%/g; s/%0D/\r/g; s/%0A/\n/g')
    #     echo "Trick to echo reg_fqdn:"
    #     echo "$value" | sed 's/./& /g' | awk '{print substr($0,1,70);exit}'
    #     # echo "$value" | sed 's/./& /g'

    - name: Log in to registry
      uses: docker/login-action@v3
      with:
        # registry: ${{ secrets.REGISTRY_PRIVATE_FQDN }} #https:// #:5000 
        # username: ${{ secrets.REGISTRY_USER }}
        # password: ${{ secrets.REGISTRY_PWD }}
        registry: ${{ env.EE_Registry }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # -
    #   name: Compose image tag
    #   id: compose-image-tag
    #   run: |
    #     echo "EE_Distro_tag=${{ secrets.REGISTRY_FQDN }}/${DistroCodeName@L}" >> $GITHUB_OUTPUT

    # -
    #   name: Cache Docker layers
    #   uses: actions/cache@v4
    #   with:
    #     path: /tmp/.buildx-cache-2
    #     key: ${{ runner.os }}-${{ github.repository }}-${{ github.ref_name }}--${{ github.ref_sha }}
    #     restore-keys: ${{ runner.os }}-${{ github.repository }}-${{ github.ref_name }}

    # - uses: docker://${{ needs.init.outputs.output_ee_distro_tag }}:latest       
    # - uses: docker://ghcr.io/<my-org>/<some-private-repo>/<some-private-image>:<tag>        

    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        ref: 'master'
        # clean: false

    - name: Restore build caches
      uses: actions/cache@v4
      with:
        path: |
          .ccache
          build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.ccache
          build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.stamps
          build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.cache_package_global
          sources
        key: ${{ runner.os }}-eddict-${{ env.DistroCodeName }}-${{ env.EE_Arch }}-ccache-${{ hashFiles('packages/**/package.mk') }}
        restore-keys: |
          ${{ runner.os }}-eddict-${{ env.DistroCodeName }}-${{ env.EE_Arch }}-ccache-

    - name: Restore apt cache
      uses: actions/cache@v4
      with:
        path: .apt-cache/archives
        key: ${{ runner.os }}-apt-${{ env.DistroCodeName }}-${{ env.EE_Arch }}-${{ hashFiles('tools/docker/**/Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-apt-${{ env.DistroCodeName }}-${{ env.EE_Arch }}-

    - name: Prepare cache dirs for container
      run: |
        BUILD_DIR="build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel"
        mkdir -p .ccache "$BUILD_DIR" .apt-cache/archives
        # ensure the global cache is a file (scripts expect a file, not a directory)
        if [ ! -e "$BUILD_DIR/.cache_package_global" ]; then
          touch "$BUILD_DIR/.cache_package_global"
        fi
        DOCKER_UID=${{ needs.init.outputs.docker_guid }}
        # use same GID as UID if we don't know the image GID (common in builder images)
        DOCKER_GID=${DOCKER_UID}
        echo "Preparing cache dirs for UID:GID ${DOCKER_UID}:${DOCKER_GID}"
        sudo chown -R ${DOCKER_UID}:${DOCKER_GID} .ccache "$BUILD_DIR" .apt-cache || true
        sudo chown ${DOCKER_UID}:${DOCKER_GID} "$BUILD_DIR/.cache_package_global" || true
        # allow the container user to create/remove files in cache dirs
        chmod -R 0775 .ccache "$BUILD_DIR" .apt-cache || true
        chmod 0664 "$BUILD_DIR/.cache_package_global" || true

    - name: Build ${{ env.EE_Distro }} image
      id: build-image
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        debug=true
        [ "$debug" = true ] && echo "[pwd]: $PWD"
        [ "$debug" = true ] && echo "[github.workspace]: ${{ github.workspace }}"
        [ "$debug" = true ] && ls -al $PWD
        # chown -R docker:docker $PWD
        # ls -al $PWD
        # docker login --username ${{ vars.DOCKERHUB_USERNAME }} --password ${{ secrets.DOCKERHUB_TOKEN }}
        # if [ "$(docker ps -aq -f status=exited -f name=build${{ env.EE_Distro }}.${{ env.DistroCodeName }})" ]; then
        #     # cleanup
        #     docker rm --force --volumes "build${{ env.EE_Distro }}.${{ env.DistroCodeName }}"
        # fi
        # set some build performance flags
        NB_CORES=$(grep -c '^processor' /proc/cpuinfo)
        [ "$debug" = true ] && echo "[NB_CORES]: $NB_CORES"

        # pull the image
        docker login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} ${{ env.EE_Registry }}
        docker --debug image pull "${{ needs.init.outputs.output_ee_distro_tag }}"
        # Diagnostic: run a short container to print UID/GID and test writing to cache dirs
        BUILD_DIR="build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel"
        echo "[debug] Running temporary container to show container UID/GID and test cache write"
        docker run --rm \
          --name "debug-${{ env.EE_Distro }}.${{ env.DistroCodeName }}" \
          -v ${{ github.workspace }}:/build \
          -v ${{ github.workspace }}/.ccache:/build/${BUILD_DIR}/.ccache \
          -w /build \
          "${{ needs.init.outputs.output_ee_distro_tag }}" sh -c "echo 'container uid:' \$(id -u); echo 'container gid:' \$(id -g); echo 'ls cache file:'; ls -lad /build/${BUILD_DIR}/.cache_package_global || true; echo 'try append'; if echo debug-$(date +%s) >> /build/${BUILD_DIR}/.cache_package_global 2>/dev/null; then echo 'write: OK'; else echo 'write: FAIL'; fi; ls -lad /build/${BUILD_DIR}/.cache_package_global || true"
        # if [ "$(docker ps -aq -f status=exited -f name=build${{ env.EE_Distro }}.${{ env.DistroCodeName }})" ]; then
        # if [ "$(docker ps -aq -f name=build${{ env.EE_Distro }}.${{ env.DistroCodeName }})" ]; then
        #     # cleanup
        #     docker rm --force --volumes "build${{ env.EE_Distro }}.${{ env.DistroCodeName }}"
        # fi

        # docker volume create ${{ env.DistroCodeName }}-ccache
        # docker create \
        #   --name "${{ env.DistroCodeName }}-ccache" \
        #   -v ${{ env.DistroCodeName }}-ccache:/build/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.ccache \
        #   debian
          # run: echo "BUILD_NAME=${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}" >> $GITHUB_OUTPUT
          # ${{ github.workspace }}/build.${{ steps.set-build-name.outputs.BUILD_NAME }}-13.0-devel/.ccache
          # ${{ github.workspace }}/build.${{ steps.set-build-name.outputs.BUILD_NAME }}-13.0-devel/.stamps
          # EE_Distro_tag="${{ env.EE_Registry }}/eddict/${DistroCodeName@L}"
          # [pwd]: /root/actions-runner/_work/EddictwareELEC/EddictwareELEC
        # run the container
        docker run --rm \
          --name "build${{ env.EE_Distro }}.${{ env.DistroCodeName }}" \
          -v ${{ github.workspace }}:/build \
          -v ${{ github.workspace }}/.ccache:/build/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.ccache \
          -v ${{ github.workspace }}/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.stamps:/build/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.stamps \
          -v ${{ github.workspace }}/.apt-cache/archives:/var/cache/apt/archives \
          -w /build \
          -e CCACHE_DIR=/build/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.ccache \
          -e DISABLE_COLORS=no \
          -e MTCOLORS=auto \
          -e ONELOG=no \
          -e LOGCOMBINE=fail \
          -e MTIMMEDIATE=no \
          -e MTDEBUG=no \
          -e MTVERBOSE=no \
          -e MTPROGRESS=no \
          -e DISTRO=${{ env.EE_Distro }} \
          -e PROJECT=${{ env.EE_Project }} \
          -e DEVICE=${{ env.EE_Device }} \
          -e ARCH=${{ env.EE_Arch }} \
          -e BUILDER_NAME=Eddict \
          -e BUILDER_VERSION="13.0-$(date +%Y%m%d)" \
          "${{ needs.init.outputs.output_ee_distro_tag }}" make -j$((NB_CORES+1)) -l${NB_CORES} image
          # "${{ needs.init.outputs.output_ee_distro_tag }}" make -j$((NB_CORES+1)) -l${NB_CORES} image
          # --volumes-from ${{ env.DistroCodeName }}-ccache \
          # -e CCACHE_DIR=/build/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.ccache \
          # --ipc=host \  #  ?? https://docs.docker.com/reference/cli/docker/container/run/#ipc
          # -e THREADCOUNT=75% \
          # --user docker \
          # --user docker \
          # --cpus="12" \
          # --memory="12g" \
          # --memory-swap="-1" \
          # --ipc="host" \
          # --log-driver local \

    - name: github-workspace
      id: ls-ghws
      run: |
        debug=true
        [ "$debug" = true ] && echo "[github.workspace]: ${{ github.workspace }}"
        [ "$debug" = true ] && ls -al ${{ github.workspace }}

    # https://stackoverflow.com/a/57877438
    - uses: actions/upload-artifact@v4
      if: always() && (steps.build-image.outcome == 'failure')
      with:
        name: artifact_logs_${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}
        path: /build/build.${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}-13.0-devel/.threads/logs/*.log
        overwrite: true
        include-hidden-files: true

    # cache artifacts are now persisted via actions/cache (restore steps above)

    -
      name: Copy built ${{ env.EE_Distro }} image to archive
      id: image-path
      run: |
        debug=true
        [ "$debug" = true ] && echo "[pwd]: ${{ github.workspace }}"
        if [ -d ${{ github.workspace }}/target ]; then
          lines=$(find ${{ github.workspace }}/target -maxdepth 1 -type f -iname "${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}*.img.gz" 2>/dev/null | wc -l)
          [ "$debug" = true ] && echo "[lines]: $lines"
          if [ $lines -ne 0 ]; then
            pathfilename=$(ls -t ${{ github.workspace }}/target/${{ env.EE_Distro }}-${{ env.EE_Device }}.${{ env.EE_Arch }}*.img.gz | head --lines=1)
            [ "$debug" = true ] && echo "[EE_image_pathfilename]: $pathfilename"
            echo "EE_image_pathfilename=$pathfilename" >> $GITHUB_OUTPUT
            filename="${pathfilename##*/}"
            [ "$debug" = true ] && echo "[EE_image_filename]: $filename"
            echo "EE_image_filename=$filename" >> $GITHUB_OUTPUT
            if [ ! -d /root/target_archive ]; then
              mkdir --parents "/root/target_archive"
            fi
            if [ "$(cp "$pathfilename" "/root/target_archive")" ]; then # --update=older
              echo "Copied built image to /root/target_archive"
            else
              echo "No newer built image to copy to /root/target_archive"
            fi
          else
            echo "No built image found in target directory, skipping copy."
          fi
        else
          echo "No target directory found, skipping copy of built image."
        fi

    - name: Upload built ${{ env.EE_Distro }} image
      if: steps.image-path.outputs.EE_image_pathfilename != ''
      uses: actions/upload-artifact@v4
      with:
        name: "${{ steps.image-path.outputs.EE_image_filename }}"
        path: "${{ steps.image-path.outputs.EE_image_pathfilename }}"

    # - # Temp fix to prevent cache size keeps growing
    #   # https://docs.docker.com/build/ci/github-actions/cache/#local-cache
    #   name: Move cache
    #   run: |
    #     rm -rf /tmp/.buildx-cache-2
    #     mv /tmp/.buildx-cache-2-new /tmp/.buildx-cache-2
 