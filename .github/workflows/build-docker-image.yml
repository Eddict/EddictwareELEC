name: Build build Container

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to run against'
        required: true
        type: choice
        options:
          - github
          - self-hosted
          - gitea
        default: github
      environment:
        description: 'Environment to run against'
        required: true
        # type: environment
        type: choice
        options:
          - bookworm
          - jammy
          - noble
          - noble-custom
          - plucky
          - questing
          - sid
        default: noble
  # deployment:
  push:
    paths: &include_paths
      - 'tools/docker/noble/Dockerfile'

run-name: ${{ format('{0} ({1}/{2})', github.workflow, inputs.runner || 'github', inputs.environment || 'noble') }}

env:
  REGISTRY: ${{ inputs.runner == 'github' && 'ghcr.io' || inputs.runner == 'gitea' && secrets.MYGITEA_REGISTRY_FQDN || 'ghcr.io' }}
  RUNNER_TOOL_CACHE: /toolcache

jobs:
  build:
    runs-on: ${{ inputs.runner == 'self-hosted' && inputs.runner || 'ubuntu-latest' }}

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    env:
      RUNNER_CHOICE: ${{ inputs.runner || 'github' }}
      ENVIRONMENT_CHOICE: ${{ inputs.environment || 'noble' }}
      BUILDKIT_PROGRESS: 'auto' #'plain' 'quiet'

    steps:
    -
      name: Get docker guid
      id: get-docker-guid
      run: |
        # Some runner images do not have a 'docker' user. Fall back to current UID.
        if id -u docker >/dev/null 2>&1; then
          echo "docker-guid=$(id -u docker)" >> $GITHUB_OUTPUT
        else
          echo "docker-guid=$(id -u)" >> $GITHUB_OUTPUT
        fi
      shell: bash

    -
      name: Compose image tag
      id: compose-image-tag
      run: |
        # dTag="${{ secrets.REGISTRY_PRIVATE_FQDN }}/${{ github.repository_owner }}/${{ inputs.environment }}"
        # dTag="${{ secrets.REGISTRY_PRIVATE_FQDN }}${{ inputs.environment }}"
        dTag="${{ env.REGISTRY }}/${{ github.repository }}-${{ env.ENVIRONMENT_CHOICE }}"
        # Use ,, to convert all characters to lowercase
        # echo "EE_Distro_tag=${dTag,,}"
        echo "EE_Distro_tag=${dTag,,}" >> $GITHUB_OUTPUT
      shell: bash

    -
      name: Log in to registry
      uses: docker/login-action@v3
      with:
        # registry: ${{ secrets.REGISTRY_PRIVATE_FQDN }} #https:// #:5000 
        # username: ${{ secrets.REGISTRY_USER }}
        # password: ${{ secrets.REGISTRY_PWD }}
        registry: ${{ env.REGISTRY }}
        username: ${{ env.RUNNER_CHOICE == 'github' && github.actor || env.RUNNER_CHOICE == 'gitea' && secrets.MYGITEA_REGISTRY_USER || secrets.REGISTRY_USER }}
        password: ${{ env.RUNNER_CHOICE == 'github' && secrets.GITHUB_TOKEN || env.RUNNER_CHOICE == 'gitea' && secrets.MYGITEA_REGISTRY_TOKEN || secrets.REGISTRY_PWD }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ steps.compose-image-tag.outputs.EE_Distro_tag }}
        # tags: |
        #   ${{ steps.compose-image-tag.outputs.EE_Distro_tag }}
        #   type=ref,event=branch
        #   type=ref,event=pr
        #   type=semver,pattern={{version}}
        #   type=semver,pattern={{major}}.{{minor}}
        labels: |
          org.opencontainers.image.source=https://github.com/Eddict/EddictwareELEC
          org.opencontainers.image.ref.name=${{ steps.compose-image-tag.outputs.EE_Distro_tag }}

    -
      name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        name: builder-eddictwareelec
        version: latest
        keep-state: true
        cleanup: false
        # https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md
        # buildkitd-config-inline: |
        #   debug = false
        #   [registry."${{ secrets.REGISTRY_PRIVATE_FQDN }}"]
        #     http = false
#        buildkitd-flags: '"--progress ''plain''"'

    # -
    #   name: Cache Docker layers
    #   uses: actions/cache@v4
    #   with:
    #     path: /tmp/.buildx-cache
    #     key: ${{ runner.os }}-${{ env.DistroCodeName }}
    #     # restore-keys: ${{ runner.os }}-${{ github.repository }}-${{ github.ref_name }}

    -
      name: Build and export to (local/private) registry
      id: push
      uses: docker/build-push-action@v6
      with:
        # context: "{{defaultContext}}:mysubdir"
        file: "./tools/docker/${{ env.ENVIRONMENT_CHOICE }}/Dockerfile"
        # outputs: type=cacheonly # build without pushing
        push: true
        tags: ${{ steps.compose-image-tag.outputs.EE_Distro_tag }}:latest
        # tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        # target: custom
        no-cache: false
        # cache-from: type=registry,ref=${{ steps.compose-image-tag.outputs.EE_Distro_tag }}:buildcache
        # cache-to: type=registry,ref=${{ steps.compose-image-tag.outputs.EE_Distro_tag }}:buildcache,mode=max
        # cache-from: type=registry,ref=${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_IMAGE_NAME }}.1:buildcache
        # cache-to: type=registry,ref=${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_IMAGE_NAME }}.1:buildcache,mode=max
        # cache-from: type=local,src=/tmp/.buildx-cache
        # cache-to: type=local,mode=max,dest=/tmp/.buildx-cache-new
        # cache-from: type=local,src=${{ runner.temp }}/.buildx-cache
        # cache-to: type=local,dest=${{ runner.temp }}/.buildx-cache-new,mode=max
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          USER_UID=${{ steps.get-docker-guid.outputs.docker-guid }}
#          --progress=plain
#          DOCKER_BUILDKIT=0

    # - # Temp fix to prevent cache size keeps growing
    #   # https://docs.docker.com/build/ci/github-actions/cache/#local-cache
    #   name: Move cache
    #   run: |
    #     rm -rf /tmp/.buildx-cache
    #     mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@v3
      with:
        subject-name: ${{ steps.compose-image-tag.outputs.EE_Distro_tag }}
        subject-digest: ${{ steps.push.outputs.digest }}
        push-to-registry: true
